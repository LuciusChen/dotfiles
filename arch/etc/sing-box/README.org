#+TITLE: sing-box é…ç½®ç®¡ç†
#+AUTHOR: Lucius
#+OPTIONS: toc:2

* æ¦‚è¿°

æœ¬ç›®å½•åŒ…å« sing-box çš„é…ç½®ç®¡ç†å·¥å…·ï¼Œé‡‡ç”¨æ¨¡æ¿åˆ†ç¦»æ¶æ„ï¼š

- =config.template.json= - é…ç½®æ¨¡æ¿ï¼ŒåŒ…å«æ‰€æœ‰è·¯ç”±è§„åˆ™ã€DNS è®¾ç½®ç­‰ï¼Œå¯æ‰‹åŠ¨ç»´æŠ¤
- =sing-box-update.sh= - è®¢é˜…æ›´æ–°è„šæœ¬ï¼Œåªè´Ÿè´£è§£æè®¢é˜…å¹¶å°†ä»£ç†èŠ‚ç‚¹æ³¨å…¥æ¨¡æ¿

è¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼šå³ä½¿è„šæœ¬å‡ºé—®é¢˜ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨ç»´æŠ¤é…ç½®ã€‚

* å¿«é€Ÿä½¿ç”¨

#+begin_src bash
sudo sing-box-update "https://example.com/subscribe"
#+end_src

è„šæœ¬ä¼šï¼š
1. ä¸‹è½½è®¢é˜…å¹¶æå–ä»£ç†èŠ‚ç‚¹
2. è¯»å–æ¨¡æ¿æ–‡ä»¶
3. å°†èŠ‚ç‚¹æ³¨å…¥æ¨¡æ¿ç”Ÿæˆæœ€ç»ˆé…ç½®
4. éªŒè¯é…ç½®å¹¶é‡å¯ sing-box

* æ–‡ä»¶è¯´æ˜

** config.template.json

é…ç½®æ¨¡æ¿æ–‡ä»¶ï¼ŒåŒ…å«ï¼š

- =log= - æ—¥å¿—è®¾ç½®
- =dns= - DNS æœåŠ¡å™¨å’Œè§„åˆ™
- =inbounds= - å…¥ç«™é…ç½®ï¼ˆtun + mixedï¼‰
- =outbounds= - å‡ºç«™é…ç½®ï¼ˆå ä½ç¬¦ï¼Œç”±è„šæœ¬å¡«å……ï¼‰
- =route= - è·¯ç”±è§„åˆ™å’Œè§„åˆ™é›†
- =experimental= - Clash API ç­‰å®éªŒæ€§åŠŸèƒ½

*** å‡ºç«™å ä½ç¬¦

æ¨¡æ¿ä¸­çš„ outbounds æ•°ç»„ç•™ç©ºï¼Œè„šæœ¬è¿è¡Œæ—¶ä¼šå¡«å……ï¼š

#+begin_src json
"outbounds": [
  {
    "type": "urltest",
    "tag": "â™»ï¸ Auto",
    "outbounds": []  // è„šæœ¬å¡«å……æ‰€æœ‰èŠ‚ç‚¹
  },
  {
    "type": "urltest",
    "tag": "ğŸ‡¯ğŸ‡µ æ—¥æœ¬è‡ªåŠ¨",
    "outbounds": []  // è„šæœ¬å¡«å……æ—¥æœ¬èŠ‚ç‚¹
  },
  {
    "type": "selector",
    "tag": "ğŸš€ Proxy",
    "outbounds": ["â™»ï¸ Auto", "DIRECT"]  // è„šæœ¬å¡«å……ä¸º ["â™»ï¸ Auto"] + æ‰€æœ‰èŠ‚ç‚¹ + ["DIRECT"]
  },
  { "type": "direct", "tag": "DIRECT" },
  { "type": "block", "tag": "REJECT" }
]
#+end_src

** sing-box-update.sh

è®¢é˜…æ›´æ–°è„šæœ¬ï¼Œæ ¸å¿ƒé€»è¾‘ï¼š

#+begin_src bash
# ä»è®¢é˜…æå–ä»£ç†èŠ‚ç‚¹
NODES=$(jq -c '[.outbounds[] | select(.type == "trojan" or .type == "vmess" ...)]' "$TEMP_FILE")

# æå–èŠ‚ç‚¹æ ‡ç­¾
ALL_TAGS=$(echo "$NODES" | jq -c '[.[].tag]')
JAPAN_TAGS=$(echo "$NODES" | jq -c '[.[] | select(.tag | test("æ—¥æœ¬")) | .tag]')

# å°†èŠ‚ç‚¹æ³¨å…¥æ¨¡æ¿
jq --argjson nodes "$NODES" \
   --argjson all_tags "$ALL_TAGS" \
   --argjson japan_tags "$JAPAN_TAGS" '
.outbounds = (
  $nodes +
  (.outbounds | map(
    if .tag == "â™»ï¸ Auto" then .outbounds = $all_tags
    elif .tag == "ğŸ‡¯ğŸ‡µ æ—¥æœ¬è‡ªåŠ¨" then .outbounds = $japan_tags
    elif .tag == "ğŸš€ Proxy" then .outbounds = (["â™»ï¸ Auto"] + $all_tags + ["DIRECT"])
    else .
    end
  ))
)
' "$TEMPLATE_FILE" > "$CONFIG_FILE"
#+end_src

* å¦‚ä½•ä¿®æ”¹é…ç½®

** ä¿®æ”¹è·¯ç”±è§„åˆ™

ç›´æ¥ç¼–è¾‘ =config.template.json= ä¸­çš„ =route.rules= æ•°ç»„ã€‚

è§„åˆ™æŒ‰é¡ºåºåŒ¹é…ï¼Œå…ˆåŒ¹é…å…ˆç”Ÿæ•ˆã€‚å¸¸ç”¨è§„åˆ™ç¤ºä¾‹ï¼š

#+begin_src json
// åŸŸååç¼€åŒ¹é…
{ "domain_suffix": ["example.com"], "action": "route", "outbound": "ğŸš€ Proxy" }

// ä½¿ç”¨è§„åˆ™é›†
{ "rule_set": "geosite-google", "action": "route", "outbound": "ğŸš€ Proxy" }

// æŒ‡å®šæ—¥æœ¬èŠ‚ç‚¹
{ "domain_suffix": ["openrouter.ai"], "action": "route", "outbound": "ğŸ‡¯ğŸ‡µ æ—¥æœ¬è‡ªåŠ¨" }

// ç›´è¿
{ "rule_set": "geosite-cn", "action": "route", "outbound": "DIRECT" }

// æ‹¦æˆªå¹¿å‘Š
{ "rule_set": "geosite-category-ads-all", "action": "reject" }

// è¿›ç¨‹ååŒ¹é…
{ "process_name": ["qbittorrent"], "action": "route", "outbound": "DIRECT" }
#+end_src

*** è§„åˆ™é¡ºåºå»ºè®®

1. DNS åŠ«æŒ
2. ç§æœ‰ IP ç›´è¿
3. å¹¿å‘Šæ‹¦æˆª
4. ç‰¹å®šç›´è¿è§„åˆ™ï¼ˆbilibili ç­‰ï¼‰
5. ä»£ç†è§„åˆ™ï¼ˆyoutubeã€googleã€telegram ç­‰ï¼‰
6. é€šç”¨ geolocation-!cn ä»£ç†
7. å›½å†…ç›´è¿ï¼ˆgeosite-cnã€geoip-cnï¼‰
8. è¿›ç¨‹è§„åˆ™

** æ·»åŠ è§„åˆ™é›†

åœ¨ =route.rule_set= æ•°ç»„ä¸­æ·»åŠ ï¼š

#+begin_src json
{
  "tag": "geosite-netflix",
  "type": "remote",
  "format": "binary",
  "url": "https://raw.githubusercontent.com/SagerNet/sing-geosite/rule-set/geosite-netflix.srs",
  "download_detour": "DIRECT"
}
#+end_src

ç„¶ååœ¨ =route.rules= ä¸­ä½¿ç”¨ï¼š

#+begin_src json
{ "rule_set": "geosite-netflix", "action": "route", "outbound": "ğŸš€ Proxy" }
#+end_src

** æ·»åŠ æ–°çš„åœ°åŒºèŠ‚ç‚¹ç»„

1. åœ¨æ¨¡æ¿çš„ =outbounds= ä¸­æ·»åŠ ï¼š

#+begin_src json
{
  "type": "urltest",
  "tag": "ğŸ‡ºğŸ‡¸ ç¾å›½è‡ªåŠ¨",
  "outbounds": [],
  "url": "https://www.gstatic.com/generate_204",
  "interval": "5m",
  "tolerance": 50
}
#+end_src

2. ä¿®æ”¹ =sing-box-update.sh= æ·»åŠ æå–é€»è¾‘ï¼š

#+begin_src bash
US_TAGS=$(echo "$NODES" | jq -c '[.[] | select(.tag | test("ç¾å›½")) | .tag]')
#+end_src

3. åœ¨ jq å‘½ä»¤ä¸­æ·»åŠ å¤„ç†ï¼š

#+begin_src bash
jq --argjson us_tags "$US_TAGS" '
  ...
  elif .tag == "ğŸ‡ºğŸ‡¸ ç¾å›½è‡ªåŠ¨" then .outbounds = $us_tags
  ...
'
#+end_src

* æ•…éšœæ’é™¤

** æŸ¥çœ‹æ—¥å¿—

#+begin_src bash
# è„šæœ¬æ—¥å¿—
cat /var/log/sing-box-update.log

# sing-box æœåŠ¡æ—¥å¿—
journalctl -u sing-box -f
#+end_src

** éªŒè¯é…ç½®

#+begin_src bash
sing-box check -c /etc/sing-box/config.json
#+end_src

** æ‰‹åŠ¨æ¢å¤

å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå¯ä»å¤‡ä»½æ¢å¤ï¼š

#+begin_src bash
ls -la /etc/sing-box/backup/
sudo cp /etc/sing-box/backup/config.json.XXXXXXXX /etc/sing-box/config.json
sudo systemctl restart sing-box
#+end_src

** è§„åˆ™é›†ä¸‹è½½å¤±è´¥

å¦‚æœæŸä¸ªè§„åˆ™é›†æ— æ³•ä¸‹è½½ï¼ˆç½‘ç»œé—®é¢˜ï¼‰ï¼Œsing-box ä¼šå¯åŠ¨å¤±è´¥ã€‚è§£å†³æ–¹æ¡ˆï¼š

1. æ£€æŸ¥æ—¥å¿—æ‰¾å‡ºæ˜¯å“ªä¸ªè§„åˆ™é›†
2. ä¸´æ—¶ä»æ¨¡æ¿ä¸­ç§»é™¤è¯¥è§„åˆ™é›†
3. æˆ–è€…æ›´æ¢è§„åˆ™é›†çš„ä¸‹è½½æº

* sing-box é…ç½®ç»“æ„å‚è€ƒ

** DNS é…ç½®

#+begin_src json
"dns": {
  "servers": [
    { "tag": "dns_proxy", "type": "udp", "server": "8.8.8.8" },
    { "tag": "dns_direct", "type": "udp", "server": "223.5.5.5" }
  ],
  "rules": [
    { "rule_set": ["geosite-cn"], "action": "route", "server": "dns_direct" }
  ]
}
#+end_src

- =dns_proxy= - ä»£ç† DNS (Google)ï¼Œè§£æå¢ƒå¤–åŸŸå
- =dns_direct= - ç›´è¿ DNS (é˜¿é‡Œ)ï¼Œè§£æå›½å†…åŸŸå

** Inbounds (å…¥ç«™)

| ç±»å‹    | ç”¨é€”                                       |
|---------+--------------------------------------------|
| =tun=   | åˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œæ¥ç®¡ç³»ç»Ÿæ‰€æœ‰æµé‡             |
| =mixed= | æä¾› HTTP/SOCKS5 ä»£ç†ç«¯å£ (7890)           |

** Outbounds (å‡ºç«™)

| ç±»å‹       | è¯´æ˜                             |
|------------+----------------------------------|
| =urltest=  | è‡ªåŠ¨æµ‹é€Ÿï¼Œé€‰æœ€å¿«çš„èŠ‚ç‚¹           |
| =selector= | æ‰‹åŠ¨é€‰æ‹©ï¼Œå¯é€šè¿‡ Clash API åˆ‡æ¢  |
| =direct=   | ç›´è¿                             |
| =block=    | æ‹¦æˆª                             |

** Clash API

è®¿é—® =http://127.0.0.1:9090/ui= å¯ä½¿ç”¨ Web ç•Œé¢ï¼š
- åˆ‡æ¢èŠ‚ç‚¹
- æŸ¥çœ‹è¿æ¥
- æµ‹è¯•å»¶è¿Ÿ
