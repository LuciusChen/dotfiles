#+TITLE: sing-box 配置管理
#+AUTHOR: Lucius
#+OPTIONS: toc:2

* 概述

本目录包含 sing-box 的配置管理工具，采用模板分离架构：

- =config.template.json= - 配置模板，包含所有路由规则、DNS 设置等，可手动维护
- =sing-box-update.sh= - 订阅更新脚本，只负责解析订阅并将代理节点注入模板

这种设计的好处是：即使脚本出问题，也可以手动维护配置。

* 快速使用

#+begin_src bash
# 首次使用（自动下载缺失的 rule set）
sudo ./sing-box-update.sh "https://example.com/subscribe"

# 强制更新 rule set
sudo ./sing-box-update.sh --force-ruleset "https://example.com/subscribe"
#+end_src

脚本会：
1. 检查并下载缺失的 rule set 到 =/var/lib/sing-box/ruleset/=
2. 下载订阅并提取代理节点
3. 读取模板文件，将节点注入生成最终配置
4. 验证配置并重启 sing-box

* 文件说明

** config.template.json

配置模板文件，包含：

- =log= - 日志设置
- =dns= - DNS 服务器和规则
- =inbounds= - 入站配置（tun + mixed）
- =outbounds= - 出站配置（占位符，由脚本填充）
- =route= - 路由规则和规则集
- =experimental= - Clash API 等实验性功能

*** 出站占位符

模板中的 outbounds 数组留空，脚本运行时会填充：

#+begin_src json
"outbounds": [
  {
    "type": "urltest",
    "tag": "Auto",
    "outbounds": []  // 脚本填充所有节点
  },
  {
    "type": "urltest",
    "tag": "Auto-JP",
    "outbounds": []  // 脚本填充日本节点
  },
  {
    "type": "selector",
    "tag": "Proxy",
    "outbounds": ["Auto", "DIRECT"]  // 脚本填充为 ["Auto"] + 所有节点 + ["DIRECT"]
  },
  { "type": "direct", "tag": "DIRECT" },
  { "type": "block", "tag": "REJECT" }
]
#+end_src

** sing-box-update.sh

订阅更新脚本，主要功能：
- 下载并管理 rule set 文件（多镜像源备选）
- 从订阅提取代理节点并去除 emoji
- 将节点注入模板生成最终配置

参数：
- =--update-ruleset= 更新 rule set 文件
- =--force-ruleset= 强制重新下载所有 rule set
- =-h, --help= 显示帮助

* 如何修改配置

** 修改路由规则

直接编辑 =config.template.json= 中的 =route.rules= 数组。

规则按顺序匹配，先匹配先生效。常用规则示例：

#+begin_src json
// 域名后缀匹配
{ "domain_suffix": ["example.com"], "action": "route", "outbound": "Proxy" }

// 使用规则集
{ "rule_set": "geosite-google", "action": "route", "outbound": "Proxy" }

// 指定日本节点
{ "domain_suffix": ["openrouter.ai"], "action": "route", "outbound": "Auto-JP" }

// 直连
{ "rule_set": "geosite-cn", "action": "route", "outbound": "DIRECT" }

// 拦截广告
{ "rule_set": "geosite-category-ads-all", "action": "reject" }

// 进程名匹配
{ "process_name": ["qbittorrent"], "action": "route", "outbound": "DIRECT" }
#+end_src

*** 规则顺序建议

1. DNS 劫持
2. 私有 IP 直连
3. 广告拦截
4. 特定直连规则（bilibili 等）
5. 代理规则（youtube、google、telegram 等）
6. 通用 geolocation-!cn 代理
7. 国内直连（geosite-cn、geoip-cn）
8. 进程规则

** 添加规则集

规则集使用本地文件（存放在 =/var/lib/sing-box/ruleset/=）。

1. 在 =route.rule_set= 数组中添加：

#+begin_src json
{
  "tag": "geosite-netflix",
  "type": "local",
  "format": "binary",
  "path": "/var/lib/sing-box/ruleset/geosite-netflix.srs"
}
#+end_src

2. 在 =sing-box-update.sh= 的 =GEOSITE_RULES= 数组中添加：

#+begin_src bash
GEOSITE_RULES=(
    ...
    "geosite-netflix"
)
#+end_src

3. 在 =route.rules= 中使用：

#+begin_src json
{ "rule_set": "geosite-netflix", "action": "route", "outbound": "Proxy" }
#+end_src

** 添加新的地区节点组

1. 在模板的 =outbounds= 中添加：

#+begin_src json
{
  "type": "urltest",
  "tag": "Auto-US",
  "outbounds": [],
  "url": "https://www.gstatic.com/generate_204",
  "interval": "5m",
  "tolerance": 50
}
#+end_src

2. 修改 =sing-box-update.sh= 中的 jq 命令，添加美国节点提取和填充逻辑（参考现有的日本节点处理）。

* 故障排除

** 查看日志

#+begin_src bash
# 脚本日志
cat /var/log/sing-box-update.log

# sing-box 服务日志
journalctl -u sing-box -f
#+end_src

** 验证配置

#+begin_src bash
sing-box check -c /etc/sing-box/config.json
#+end_src

** 手动恢复

如果更新失败，可从备份恢复：

#+begin_src bash
ls -la /etc/sing-box/backup/
sudo cp /etc/sing-box/backup/config.json.XXXXXXXX /etc/sing-box/config.json
sudo systemctl restart sing-box
#+end_src

** 规则集问题

规则集文件存放在 =/var/lib/sing-box/ruleset/=，由脚本预先下载。

#+begin_src bash
# 查看已下载的规则集
ls -la /var/lib/sing-box/ruleset/

# 强制重新下载所有规则集
sudo ./sing-box-update.sh --force-ruleset "https://..."
#+end_src

如果下载失败，脚本会尝试多个镜像源（ghproxy、jsdelivr、GitHub 直连）。

* sing-box 配置结构参考

** DNS 配置

#+begin_src json
"dns": {
  "servers": [
    { "tag": "dns_proxy", "type": "udp", "server": "8.8.8.8" },
    { "tag": "dns_direct", "type": "udp", "server": "223.5.5.5" }
  ],
  "rules": [
    { "rule_set": ["geosite-cn"], "action": "route", "server": "dns_direct" }
  ]
}
#+end_src

- =dns_proxy= - 代理 DNS (Google)，解析境外域名
- =dns_direct= - 直连 DNS (阿里)，解析国内域名

** Inbounds (入站)

| 类型    | 用途                                       |
|---------+--------------------------------------------|
| =tun=   | 创建虚拟网卡，接管系统所有流量             |
| =mixed= | 提供 HTTP/SOCKS5 代理端口 (7890)           |

** Outbounds (出站)

| 类型       | 说明                             |
|------------+----------------------------------|
| =urltest=  | 自动测速，选最快的节点           |
| =selector= | 手动选择，可通过 Clash API 切换  |
| =direct=   | 直连                             |
| =block=    | 拦截                             |

** Clash API

访问 =http://127.0.0.1:9090/ui= 可使用 Web 界面：
- 切换节点
- 查看连接
- 测试延迟
