#+TITLE: sing-box-update.sh è„šæœ¬æ–‡æ¡£
#+AUTHOR: Lucius
#+OPTIONS: toc:2

* æ¦‚è¿°

è¿™ä¸ªè„šæœ¬ç”¨äºä»è®¢é˜…é“¾æ¥ä¸‹è½½ä»£ç†èŠ‚ç‚¹ï¼Œå¹¶ç”Ÿæˆå®Œæ•´çš„ sing-box é…ç½®æ–‡ä»¶ã€‚

#+begin_src bash
sudo sing-box-update "https://example.com/subscribe"
#+end_src

* è„šæœ¬ç»“æ„è§£æ

** ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€è®¾ç½® (1-13è¡Œ)

#+begin_src bash
#!/bin/bash
set -e
#+end_src

- =#!/bin/bash= - shebangï¼ŒæŒ‡å®šç”¨ bash è§£é‡Šå™¨æ‰§è¡Œ
- =set -e= - é‡åˆ°é”™è¯¯ç«‹å³é€€å‡ºï¼Œä¸ç»§ç»­æ‰§è¡Œåç»­å‘½ä»¤

#+begin_src bash
CONFIG_DIR="/etc/sing-box"
CONFIG_FILE="${CONFIG_DIR}/config.json"
BACKUP_DIR="${CONFIG_DIR}/backup"
LOG_FILE="/var/log/sing-box-update.log"
#+end_src

å®šä¹‰è·¯å¾„å˜é‡ã€‚=${VAR}= æ˜¯å˜é‡å±•å¼€çš„å®‰å…¨å†™æ³•ï¼Œé¿å…æ­§ä¹‰ã€‚

** ç¬¬äºŒéƒ¨åˆ†ï¼šæ—¥å¿—å‡½æ•° (15-18è¡Œ)

#+begin_src bash
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}
#+end_src

| è¯­æ³•             | å«ä¹‰                             |
|------------------+----------------------------------|
| =log()=          | å®šä¹‰ä¸€ä¸ªå‡½æ•°                     |
| =$1=             | å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°                 |
| =$(date ...)=    | å‘½ä»¤æ›¿æ¢ï¼Œæ‰§è¡Œ date å¹¶æ’å…¥ç»“æœ   |
| =tee -a=         | åŒæ—¶è¾“å‡ºåˆ°å±å¹•å’Œè¿½åŠ åˆ°æ–‡ä»¶       |

** ç¬¬ä¸‰éƒ¨åˆ†ï¼šå‚æ•°æ£€æŸ¥ (20-27è¡Œ)

#+begin_src bash
if [[ -z "$1" ]]; then
    echo "Usage: $0 <subscription_url>"
    exit 1
fi
SUBSCRIBE_URL="$1"
#+end_src

- =[[ -z "$1" ]]= - æ£€æŸ¥ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦ä¸ºç©º
- =$0= - è„šæœ¬è‡ªèº«çš„åç§°
- =exit 1= - ä»¥é”™è¯¯ç  1 é€€å‡º

** ç¬¬å››éƒ¨åˆ†ï¼šå¤‡ä»½ç°æœ‰é…ç½® (34-38è¡Œ)

#+begin_src bash
if [[ -f "$CONFIG_FILE" ]]; then
    cp "$CONFIG_FILE" "${BACKUP_DIR}/config.json.$(date +%Y%m%d_%H%M%S)"
fi
#+end_src

- =[[ -f "$CONFIG_FILE" ]]= - æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- å¤‡ä»½æ–‡ä»¶åå¸¦æ—¶é—´æˆ³ï¼Œå¦‚ =config.json.20260126_174133=

** ç¬¬äº”éƒ¨åˆ†ï¼šä¸‹è½½è®¢é˜… (40-55è¡Œ)

#+begin_src bash
TEMP_FILE=$(mktemp)

if ! curl -sL --connect-timeout 30 --max-time 60 -o "$TEMP_FILE" "$SUBSCRIBE_URL"; then
    log "ERROR: Failed to download subscription"
    rm -f "$TEMP_FILE"
    exit 1
fi

if ! jq empty "$TEMP_FILE" 2>/dev/null; then
    log "ERROR: Invalid JSON received"
    rm -f "$TEMP_FILE"
    exit 1
fi
#+end_src

| å‘½ä»¤/å‚æ•°            | å«ä¹‰                       |
|----------------------+----------------------------|
| =mktemp=             | åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼Œè¿”å›è·¯å¾„     |
| =curl -s=            | é™é»˜æ¨¡å¼                   |
| =curl -L=            | è·Ÿéšé‡å®šå‘                 |
| =--connect-timeout=  | è¿æ¥è¶…æ—¶ç§’æ•°               |
| =--max-time=         | æ€»è¶…æ—¶ç§’æ•°                 |
| =-o=                 | è¾“å‡ºåˆ°æ–‡ä»¶                 |
| =if ! command=       | å¦‚æœå‘½ä»¤å¤±è´¥åˆ™æ‰§è¡Œ then    |
| =jq empty=           | éªŒè¯ JSON æ ¼å¼æ˜¯å¦æ­£ç¡®     |
| =2>/dev/null=        | ä¸¢å¼ƒé”™è¯¯è¾“å‡º               |

** ç¬¬å…­éƒ¨åˆ†ï¼šæå–ä»£ç†èŠ‚ç‚¹ (57-74è¡Œ)

#+begin_src bash
NODES=$(jq '[.outbounds[] | select(.type == "trojan" or .type == "vmess" ...)]' "$TEMP_FILE")
NODE_COUNT=$(echo "$NODES" | jq 'length')
NODE_TAGS=$(echo "$NODES" | jq '[.[].tag]')
JAPAN_TAGS=$(echo "$NODES" | jq '[.[] | select(.tag | test("æ—¥æœ¬")) | .tag]')
#+end_src

*** jq è¯­æ³•è§£æ

| è¡¨è¾¾å¼              | å«ä¹‰                               |
|---------------------+------------------------------------|
| =.outbounds[]=      | éå† outbounds æ•°ç»„çš„æ¯ä¸ªå…ƒç´       |
| =select(æ¡ä»¶)=      | è¿‡æ»¤ï¼Œåªä¿ç•™æ»¡è¶³æ¡ä»¶çš„å…ƒç´          |
| =.type == "trojan"= | æ£€æŸ¥ type å­—æ®µæ˜¯å¦ç­‰äº "trojan"    |
| =[...]=             | å°†ç»“æœæ”¶é›†æˆæ•°ç»„                   |
| =.[].tag=           | å–æ¯ä¸ªå…ƒç´ çš„ tag å­—æ®µ              |
| =test("æ—¥æœ¬")=      | æ­£åˆ™åŒ¹é…ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å«"æ—¥æœ¬"       |
| =length=            | è¿”å›æ•°ç»„é•¿åº¦                       |

*** ç¤ºä¾‹

#+begin_src bash
# è¾“å…¥
{"outbounds": [{"type": "trojan", "tag": "é¦™æ¸¯ 01"}, {"type": "direct", "tag": "DIRECT"}]}

# .outbounds[] | select(.type == "trojan") ç»“æœ
{"type": "trojan", "tag": "é¦™æ¸¯ 01"}
#+end_src

** ç¬¬ä¸ƒéƒ¨åˆ†ï¼šç”Ÿæˆé…ç½® (78-196è¡Œ)

#+begin_src bash
jq -n --argjson nodes "$NODES" --argjson tags "$NODE_TAGS" --argjson japan_tags "$JAPAN_TAGS" '
{
  ...é…ç½®æ¨¡æ¿...
}'  > "$CONFIG_FILE"
#+end_src

*** jq å‚æ•°

| å‚æ•°                   | å«ä¹‰                                         |
|------------------------+----------------------------------------------|
| =-n=                   | ä¸è¯»å–è¾“å…¥ï¼Œä»é›¶å¼€å§‹æ„å»º JSON                |
| =--argjson name value= | å°† shell å˜é‡ä½œä¸º JSON ä¼ å…¥ jqï¼Œç”¨ =$name= å¼•ç”¨ |

*** é…ç½®æ¨¡æ¿ä¸­çš„ jq è¡¨è¾¾å¼

#+begin_src jq
# æ•°ç»„æ‹¼æ¥
"outbounds": ($nodes + [...])

# å¤šæ•°ç»„æ‹¼æ¥
"outbounds": (["â™»ï¸ Auto"] + $tags + ["DIRECT"])
#+end_src

** ç¬¬å…«éƒ¨åˆ†ï¼šéªŒè¯å’Œé‡å¯ (200-214è¡Œ)

#+begin_src bash
if ! sing-box check -c "$CONFIG_FILE" 2>/dev/null; then
    log "WARNING: Config validation failed, but continuing..."
fi

if systemctl is-active --quiet sing-box; then
    systemctl restart sing-box
else
    systemctl start sing-box
fi
#+end_src

- =sing-box check -c= - éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•
- =systemctl is-active --quiet= - æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œä¸­

** ç¬¬ä¹éƒ¨åˆ†ï¼šæ¸…ç†æ—§å¤‡ä»½ (217è¡Œ)

#+begin_src bash
ls -t "${BACKUP_DIR}"/config.json.* 2>/dev/null | tail -n +6 | xargs -r rm -f
#+end_src

| å‘½ä»¤            | ä½œç”¨                               |
|-----------------+------------------------------------|
| =ls -t=         | æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰             |
| =tail -n +6=    | ä»ç¬¬ 6 è¡Œå¼€å§‹è¾“å‡ºï¼ˆè·³è¿‡å‰ 5 ä¸ªï¼‰   |
| =xargs -r rm -f= | åˆ é™¤è¿™äº›æ–‡ä»¶ï¼Œ=-r= æ— è¾“å…¥æ—¶ä¸æ‰§è¡Œ |

ç»“æœï¼šä¿ç•™æœ€æ–° 5 ä¸ªå¤‡ä»½ï¼Œåˆ é™¤æ›´æ—§çš„ã€‚

* sing-box é…ç½®ç»“æ„

** DNS é…ç½®

#+begin_src json
"dns": {
  "servers": [
    { "tag": "dns_proxy", "server": "8.8.8.8" },
    { "tag": "dns_direct", "server": "223.5.5.5" }
  ],
  "rules": [
    { "rule_set": ["geosite-cn"], "server": "dns_direct" }
  ]
}
#+end_src

- =dns_proxy= - ä»£ç† DNS (Google)
- =dns_direct= - ç›´è¿ DNS (é˜¿é‡Œ)ï¼Œå›½å†…åŸŸåä½¿ç”¨

** Inbounds (å…¥ç«™)

#+begin_src json
"inbounds": [
  { "type": "tun", ... },
  { "type": "mixed", "listen_port": 7890, ... }
]
#+end_src

| ç±»å‹    | ç”¨é€”                                       |
|---------+--------------------------------------------|
| =tun=   | åˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œæ¥ç®¡ç³»ç»Ÿæ‰€æœ‰æµé‡             |
| =mixed= | æä¾› HTTP å’Œ SOCKS5 ä»£ç†ç«¯å£ï¼Œä¾›åº”ç”¨æ‰‹åŠ¨é…ç½® |

** Outbounds (å‡ºç«™)

#+begin_src json
"outbounds": [
  { "type": "trojan", "tag": "é¦™æ¸¯ 01", ... },
  { "type": "urltest", "tag": "â™»ï¸ Auto", "outbounds": [...] },
  { "type": "urltest", "tag": "ğŸ‡¯ğŸ‡µ æ—¥æœ¬è‡ªåŠ¨", "outbounds": [...] },
  { "type": "selector", "tag": "ğŸš€ Proxy", "outbounds": [...] },
  { "type": "direct", "tag": "DIRECT" },
  { "type": "block", "tag": "REJECT" }
]
#+end_src

| ç±»å‹       | è¯´æ˜                           |
|------------+--------------------------------|
| =urltest=  | è‡ªåŠ¨æµ‹é€Ÿï¼Œé€‰æœ€å¿«çš„èŠ‚ç‚¹         |
| =selector= | æ‰‹åŠ¨é€‰æ‹©ï¼Œå¯é€šè¿‡ Clash API åˆ‡æ¢ |
| =direct=   | ç›´è¿ï¼Œä¸èµ°ä»£ç†                 |
| =block=    | æ‹¦æˆªï¼Œä¸¢å¼ƒè¯·æ±‚                 |

** Route Rules (è·¯ç”±è§„åˆ™)

è§„åˆ™æŒ‰é¡ºåºåŒ¹é…ï¼Œå…ˆåŒ¹é…å…ˆç”Ÿæ•ˆï¼š

#+begin_src json
"rules": [
  { "protocol": "dns", "action": "hijack-dns" },
  { "ip_is_private": true, "outbound": "DIRECT" },
  { "rule_set": "geosite-category-ads-all", "action": "reject" },
  { "rule_set": "geosite-cn", "outbound": "DIRECT" },
  { "rule_set": "geoip-cn", "outbound": "DIRECT" },
  { "domain_suffix": ["openrouter.ai"], "outbound": "ğŸ‡¯ğŸ‡µ æ—¥æœ¬è‡ªåŠ¨" },
  { "rule_set": "geosite-geolocation-!cn", "outbound": "ğŸš€ Proxy" },
  { "process_name": ["qbittorrent"], "outbound": "DIRECT" }
],
"final": "ğŸš€ Proxy"
#+end_src

*** å¸¸ç”¨åŒ¹é…æ¡ä»¶

| æ¡ä»¶            | è¯´æ˜             |
|-----------------+------------------|
| =domain_suffix= | åŸŸååç¼€åŒ¹é…     |
| =domain=        | å®Œæ•´åŸŸååŒ¹é…     |
| =rule_set=      | ä½¿ç”¨é¢„å®šä¹‰è§„åˆ™é›† |
| =ip_is_private= | ç§æœ‰ IP åœ°å€     |
| =process_name=  | è¿›ç¨‹ååŒ¹é…       |
| =protocol=      | åè®®ç±»å‹         |

* å¦‚ä½•æ‰©å±•

** æ·»åŠ æ–°çš„åœ°åŒºèŠ‚ç‚¹ç»„

#+begin_src bash
# 1. æå–èŠ‚ç‚¹
US_TAGS=$(echo "$NODES" | jq '[.[] | select(.tag | test("ç¾å›½")) | .tag]')

# 2. åœ¨ jq å‘½ä»¤ä¸­æ·»åŠ å‚æ•°
jq -n --argjson us_tags "$US_TAGS" ...

# 3. åœ¨ outbounds ä¸­æ·»åŠ 
{
  "type": "urltest",
  "tag": "ğŸ‡ºğŸ‡¸ ç¾å›½è‡ªåŠ¨",
  "outbounds": $us_tags
}

# 4. åœ¨ rules ä¸­ä½¿ç”¨
{ "domain_suffix": ["netflix.com"], "outbound": "ğŸ‡ºğŸ‡¸ ç¾å›½è‡ªåŠ¨" }
#+end_src

** æ·»åŠ æ–°çš„è·¯ç”±è§„åˆ™

#+begin_src json
// åŸºäºåŸŸå
{ "domain_suffix": ["example.com"], "outbound": "ğŸš€ Proxy" }

// åŸºäºè¿›ç¨‹
{ "process_name": ["firefox", "chrome"], "outbound": "ğŸš€ Proxy" }

// åŸºäºè§„åˆ™é›†
{ "rule_set": "geosite-netflix", "outbound": "ğŸ‡ºğŸ‡¸ ç¾å›½è‡ªåŠ¨" }
#+end_src
